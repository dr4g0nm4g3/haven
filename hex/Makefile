# HEX pre-alpha exokernel Makefile

TARGET := i686-pc-elf
GCCVER := 4.8.2
HCC_PATH ?= $(CURDIR)/../hcc
# $(CURDIR) will evaluate to the directory from which this make file is running 
PROJDIR := $(CURDIR)

# build configuration: either dbg (debug) or rel (release); default is release
BUILD_CONFIG = release

#target architecture to build (default is x86)
TARGET_ARCH ?= i386

# processor architecture
TARGET_PROC = i686

# define the tools to use here
CPP = $(HCC_PATH)/$(TARGET_PROC)/bin/$(TARGET)-g++
CC  = $(HCC_PATH)/$(TARGET_PROC)/bin/$(TARGET)-gcc
LD = $(HCC_PATH)/$(TARGET_PROC)/bin/$(TARGET)-ld
AR = $(HCC_PATH)/$(TARGET_PROC)/bin/$(TARGET)-ar
RANLIB = $(HCC_PATH)/$(TARGET_PROC)/bin/$(TARGET)-ranlib
ASM = nasm
OBJDUMP = $(HCC_PATH)/$(TARGET_PROC)/bin/$(TARGET)-objdump
RM = rm -f

# output directory
OUTPUTDIR = $(PROJDIR)/bin/$(BUILD_CONFIG)/$(TARGET_PROC)

# other files (readme, makefile, etc..)
AUXFILES := Makefile README TODO

# top level directories in the project to search for files
PROJDIRS := arch/$(TARGET_ARCH) include kernel lib

#find all .c, .s and .h files in the project directory, searching at least 5 directories deep
SRCFILES := $(shell find $(PROJDIRS) -mindepth 1 -maxdepth 5 -name "*.c")
HDRFILES := $(shell find $(PROJDIRS) -mindepth 1 -maxdepth 5 -name "*.h")
ASMFILES := $(shell find $(PROJDIRS) -mindepth 1 -maxdepth 5 -name "*.s")

# create list of supported architectures by looking at 'arch' directory
ARCHLIST := $(shell find $(PROJDIR)/arch -mindepth 1 -maxdepth 1 -type d -path '$(PROJDIR)/arch/.svn' -prune -o -print)

# substitute *.c and *.s for *.o (object files)
ASMOBJFILES := $(patsubst %.s,%.o,$(ASMFILES))
COBJFILES := $(patsubst %.c,%.o,$(SRCFILES))
DEPFILES := $(patsubst %.s,%.d,$(ASMFILES)) \
						$(patsubst %.c,%.d,$(SRCFILES))
ALLFILES := $(SRCFILES) $(HDRFILES) $(ASMFILES) $(AUXFILES)

# library path for compiler
LIBS =  -L"$(HCC_PATH)/$(TARGET_PROC)/lib/gcc/$(TARGET)/$(GCCVER)" -L"$(HCC_PATH)/$(TARGET_PROC)/lib"

# include paths for compiler
INCS =  -I"$(HCC_PATH)/$(TARGET_PROC)/lib/gcc/$(TARGET)/$(GCCVER)/include" \
				 -I"$(PROJDIR)/include" \
				 -I"$(PROJDIR)/include/lib" \
				  -I"$(PROJDIR)/arch/$(TARGET_ARCH)/include" \
				  -I"$(PROJDIR)/arch/$(TARGET_ARCH)/include/debug" \
				  -I"$(PROJDIR)/arch/$(TARGET_ARCH)/include/mm" \
				  -I"$(PROJDIR)/arch/$(TARGET_ARCH)/include/ut"

# c++ compiler include paths
CXXINCS =  -I"$(PROJDIR)/include"  -I"$(PROJDIR)/arch/$(TARGET_ARCH)/include"

# c++ compiler flags
CXXFLAGS = $(CXXINCS) -Wall -Werror -nodefaultlibs -nostdlib -nostartfiles -fno-builtin

# c compiler flags
CFLAGS = $(INCS) -Wall -Werror -nodefaultlibs -nostdlib -nostartfiles -fno-builtin

# flags for generating debug info
CDBGFLAGS = -ggdb -gstabs

# kernel binary name
BIN  = hkernel


# available processor architectures:
#		i686 --> builds for 32-bit Intel/AMD processors
#		x86_64 --> builds for 64-bit Intel/AMD processors
#
#	NOTE: if no architecture is specified, default is i686

.PHONY: all clean clean-custom todolist arch

all: $(BIN)
	$(OBJDUMP) -D -t -l $(BIN) > hex.symbols
	-@mv $(BIN) $(OUTPUTDIR)

$(BIN): $(ASMOBJFILES) $(COBJFILES)
	@$(LD) -T ./kernel/linker.ld -o $(BIN) $(ASMOBJFILES) $(COBJFILES)

# add all dependency rules auto-generated by make
-include $(DEPFILES)

# clean up intermediary files
clean: clean-custom
	-@for file in $(COBJFILES) $(ASMOBJFILES) $(DEPFILES) $(BIN); do if [ -f $$file ]; then rm $$file; fi; done
	$(RM) hex.symbols
	$(RM) $(OUTPUTDIR)/$(BIN)

# print out lines containing the text 'TODO' in all files
todolist:
	-@for file in $(ALLFILES); do grep -H TODO $$file; done; true

#print out a list of supported architectures for which the kernel can be built
arch:
	-@for dir in $(ARCHLIST); echo $$dir; done

# pattern matching rules
$(ASMOBJFILES): %.o: %.s
	@$(ASM) -f elf -o $@ $<

$(COBJFILES): %.o: %.c
	@$(CC) -c $(CFLAGS) $< -o $@ 

