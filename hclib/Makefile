# HCLIB Makefile

DEVROOT := $(HOME)/Dev
TARGET := i686-pc-elf
HCC_PATH ?= $(CURDIR)/../hcc
TARGET_PROC ?= i686

# This variable defines which platform you are compiling for.
PLATFORM := example

# compilers to use
CPP  = $(HCC_PATH)/$(TARGET_PROC)/bin/i686-pc-elf-g++
CC   = $(HCC_PATH)/$(TARGET_PROC)/bin/i686-pc-elf-gcc

# other files (readme, makefile, etc..)
AUXFILES := Makefile
# top level directories in the project to search for files
PROJDIRS := functions includes internals
#find all .c and .h files in the project directory, searching at least 3 directories deep
SRCFILES := $(shell find $(PROJDIRS) -mindepth 1 -maxdepth 3 -name "*.c")
HDRFILES := $(shell find $(PROJDIRS) -mindepth 1 -maxdepth 3 -name "*.h")
# substitute *.c for *.o (object files) or *.t (test files) for prerequisites
# All test drivers (.t)
TSTFILES := $(patsubst %.c,%_t,$(SRCFILES))
OBJFILES := $(patsubst %.c,%.o,$(SRCFILES))
DEPFILES := $(patsubst %.c,%.d,$(SRCFILES))
# All test driver dependency files (_t.d)
TSTDEPFILES := $(patsubst %,%.d,$(TSTFILES))
ALLFILES := $(SRCFILES) $(HDRFILES) $(AUXFILES)

# library path for compiler
LIBS =  -L"$(HCC_PATH)/$(TARGET_PROC)/lib/gcc/$(TARGET)/4.1.2" -L"$(HCC_PATH)/$(TARGET_PROC)/lib" -L"$(DEVROOT)/Haven/hclib"
# include paths for compiler
INCS =  -I"$(HCC_PATH)/$(TARGET_PROC)/lib/gcc/$(TARGET)/4.1.2/include"  -I"$(CURDIR)/includes"  -I"$(CURDIR)/internals"
# c++ compiler include paths
CXXINCS =  -I"$(CURDIR)/includes"  -I"$(CURDIR)/internals"
# c++ compiler flags
CXXFLAGS = $(CXXINCS)   -Wall -Werror -nodefaultlibs -nostdlib -nostartfiles
# c compiler flags
CFLAGS = $(INCS) -std=c99 -Wall -Werror -nodefaultlibs -nostdlib -nostartfiles -fno-builtin
BIN = libhclib.a
RM = rm -f

#TODO: include target to generate documentation using doxygen
#TODO: add targets to generate C library for different platforms
#TODO: make 'lib' output directory for all library files
.PHONY: all clean clean-custom test todolist testdrivers

all: $(BIN)

#TODO: include packaging of doxygen generated documentation
# archiving
libhclib.a: $(OBJFILES)
	@ar rc $(BIN) $?
	@ranlib $(BIN)

# generate test files from each source file
test: testdrivers
	-rc=0; for file in $(TSTFILES); do ./$$file; rc=`expr $$rc + $$?`; done; echo; echo "Tests failed: $$rc"

testdrivers: $(TSTFILES)

# add all dependency rules auto-generated by make
-include $(DEPFILES) $(TSTDEPFILES)

# delete .o and .a files
clean: clean-custom
	-@for file in $(OBJFILES) $(DEPFILES) $(TSTFILES) $(BIN) hclib.tgz; do if [ -f $$file ]; then rm $$file; fi; done

# zip up the entire directory for distribution
dist:
	@tar czf hclib.tgz $(ALLFILES)

# print out lines containing the text 'TODO' in all files
todolist:
	-@for file in $(ALLFILES); do grep -H TODO $$file; done; true

# generate object files for all source
%.o: %.c Makefile
	@$(CC) $(CFLAGS) -MMD -MP -c $< -o $@

# run tests from test files
%_t: %.c Makefile $(BIN)
	$(CC) -MMD -MP -DTEST $(CFLAGS) $< libhclib.a -o $@

